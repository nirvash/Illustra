name: Release

on:
  push:
    tags:
      - "v*.*.*"

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write
      issues: read # æ—¢çŸ¥ã®å•é¡Œã‚’å–å¾—ã™ã‚‹ãŸã‚ã®æ¨©é™ã‚’è¿½åŠ 

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # ã™ã¹ã¦ã®å±¥æ­´ã‚’å–å¾—ã—ã¦å¤‰æ›´å±¥æ­´ã‚’ç”Ÿæˆã™ã‚‹ãŸã‚

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Restore dependencies
        run: dotnet restore

      - name: Build
        run: dotnet build --no-restore --configuration Release

      - name: Publish
        run: dotnet publish src/Illustra.csproj -c Release -o publish --self-contained true -r win-x64 /p:PublishSingleFile=true /p:IncludeNativeLibrariesForSelfExtract=true

      - name: Create ZIP archive
        run: |
          cd publish
          7z a -tzip "../Illustra-${{ github.ref_name }}.zip" *

      - name: Read Release Notes
        id: read_release_notes
        run: |
          if (Test-Path ".github/workflows/summary.txt") {
            $notes = Get-Content -Path ".github/workflows/summary.txt"
            if ([string]::IsNullOrWhiteSpace($notes)) {
              $notes = "- ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã®æ”¹å–„ã¨ãƒã‚°ä¿®æ­£"
            }
            $notesFormatted = $notes -join "%0A"
            echo "summary=$notesFormatted" >> $env:GITHUB_OUTPUT
          } else {
            echo "summary=- ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã®æ”¹å–„ã¨ãƒã‚°ä¿®æ­£%0A- ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Š" >> $env:GITHUB_OUTPUT
          }
        shell: pwsh

      - name: Get Known Issues
        id: issues
        run: |
          $token = "${{ github.token }}"
          $repoUrl = "${{ github.repository }}"

          # GraphQLã‚¯ã‚¨ãƒªã‚’1è¡Œã§ä½œæˆ
          $query = '{ "query": "query { repository(owner: \"' + $repoUrl.Split('/')[0] + '\", name: \"' + $repoUrl.Split('/')[1] + '\") { issues(first: 5, states: OPEN, labels: [\"bug\"]) { nodes { title url } } } }" }'

          $headers = @{
            "Authorization" = "Bearer $token"
            "Content-Type" = "application/json"
          }

          $response = Invoke-RestMethod -Uri "https://api.github.com/graphql" -Method Post -Headers $headers -Body $query

          # æ—¢çŸ¥ã®å•é¡Œãƒªã‚¹ãƒˆã‚’ç”Ÿæˆ
          $issues = $response.data.repository.issues.nodes | ForEach-Object { "- [$($_.title)]($($_.url))" }

          # æ—¢çŸ¥ã®å•é¡ŒãŒãªã„å ´åˆã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
          if ($issues.Count -eq 0) {
            $issues = "- ç¾åœ¨ã€æ—¢çŸ¥ã®å•é¡Œã¯ã‚ã‚Šã¾ã›ã‚“ã€‚"
          }

          # æ”¹è¡Œã‚’GitHub Actionsã®ç‰¹æ®Šæ§‹æ–‡ã«å¤‰æ›
          $issuesList = $issues -join "%0A"

          # å‡ºåŠ›è¨­å®š
          echo "issues=$issuesList" >> $env:GITHUB_OUTPUT
        shell: pwsh

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          draft: false
          prerelease: false
          files: |
            Illustra-${{ github.ref_name }}.zip
          body: |
            ## ğŸš€ Illustra ${{ github.ref_name }}

            ### ğŸ“¦ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•
            1. Illustra-${{ github.ref_name }}.zip ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            2. ãŠå¥½ã¿ã®å ´æ‰€ã«å±•é–‹
            3. Illustra.exe ã‚’å®Ÿè¡Œ

            ### ğŸ’» å‹•ä½œç’°å¢ƒ
            - Windows 10/11
            - .NET 9.0 ä»¥é™ï¼ˆå®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«ã«åŒæ¢±ï¼‰

            ### ğŸ“ å¤‰æ›´ç‚¹
            ${{ steps.read_release_notes.outputs.summary }}

            ### ğŸ” æ—¢çŸ¥ã®å•é¡Œ
            ${{ steps.issues.outputs.issues }}
