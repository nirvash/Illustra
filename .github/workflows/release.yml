name: Release

on:
  push:
    tags:
      - "v*.*.*"

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write
      issues: read # æ—¢çŸ¥ã®å•é¡Œã‚’å–å¾—ã™ã‚‹ãŸã‚ã®æ¨©é™

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # ã™ã¹ã¦ã®å±¥æ­´ã‚’å–å¾—ã—ã¦å¤‰æ›´å±¥æ­´ã‚’ç”Ÿæˆã™ã‚‹ãŸã‚

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Restore dependencies
        run: dotnet restore src/Illustra.csproj

      - name: Setup GitVersion
        uses: gittools/actions/gitversion/setup@v3.1.11
        with:
          versionSpec: '5.12.0'  # å³å¯†ã«5.12.0ã‚’æŒ‡å®š

      - name: Execute GitVersion
        id: gitversion
        uses: gittools/actions/gitversion/execute@v3.1.11
        with:
          useConfigFile: true
          configFilePath: ${{ github.workspace }}/src/GitVersion.yml

      - name: Display GitVersion outputs
        run: |
          echo "SemVer: ${{ steps.gitversion.outputs.semVer }}"
          echo "FullSemVer: ${{ steps.gitversion.outputs.fullSemVer }}"
      - name: Build
        run: dotnet build src/Illustra.csproj --configuration Release

      - name: Publish
        run: dotnet publish src/Illustra.csproj -c Release -o publish --self-contained true -r win-x64 /p:PublishSingleFile=true /p:IncludeNativeLibrariesForSelfExtract=true

      - name: Create ZIP archive
        shell: bash # Windowsã§ã‚‚Bashã§çµ±ä¸€
        run: |
          cd publish
          7z a -tzip "../Illustra-${GITHUB_REF_NAME}.zip" *

      - name: Generate Release Notes
        id: read_release_notes
        shell: bash
        run: |
          # æœ€æ–°ã®ã‚¿ã‚°ã‚’å–å¾—ï¼ˆç¾åœ¨ã®ã‚¿ã‚°ï¼‰
          current_tag=${GITHUB_REF_NAME}

          # 1ã¤å‰ã®ã‚¿ã‚°ã‚’å–å¾—
          previous_tag=$(git describe --tags --abbrev=0 ${current_tag}^ 2>/dev/null || echo "")

          if [ -z "$previous_tag" ]; then
            # å‰å›ã®ã‚¿ã‚°ãŒãªã„å ´åˆã¯ã€å…¨ã¦ã®ã‚³ãƒŸãƒƒãƒˆã‚’å¯¾è±¡ã¨ã™ã‚‹
            commits=$(git log --pretty=format:"- %s" --reverse)
          else
            # å‰å›ã®ã‚¿ã‚°ã‹ã‚‰ç¾åœ¨ã®ã‚¿ã‚°ã¾ã§ã®ã‚³ãƒŸãƒƒãƒˆã‚’å–å¾—
            commits=$(git log --pretty=format:"- %s" --reverse ${previous_tag}..${current_tag})
          fi

          # ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚«ãƒ†ã‚´ãƒªã”ã¨ã«æ•´ç†
          features=$(echo "$commits" | grep -i "^- feat:" || echo "")
          fixes=$(echo "$commits" | grep -i "^- fix:" || echo "")
          other=$(echo "$commits" | grep -v "^- feat:" | grep -v "^- fix:" || echo "")

          # Create separate outputs for Japanese and English sections
          jp_output=""
          en_output=""

          if [ ! -z "$features" ]; then
            jp_output+="âœ¨ æ–°æ©Ÿèƒ½:\n$features\n\n"
            en_output+="âœ¨ New Features:\n$features\n\n"
          fi
          if [ ! -z "$fixes" ]; then
            jp_output+="ğŸ› ãƒã‚°ä¿®æ­£:\n$fixes\n\n"
            en_output+="ğŸ› Bug Fixes:\n$fixes\n\n"
          fi
          if [ ! -z "$other" ]; then
            jp_output+="ğŸ”§ ãã®ä»–ã®å¤‰æ›´:\n$other"
            en_output+="ğŸ”§ Other Changes:\n$other"
          fi

          # Create final output
          output="$jp_output"

          # å‡ºåŠ›ãŒç©ºã®å ´åˆã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ (æ—¥æœ¬èªã¨è‹±èªã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’åˆ†é›¢)
          if [ -z "$output" ]; then
            jp_output="- ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã®æ”¹å–„ã¨ãƒã‚°ä¿®æ­£"
            en_output="- Maintenance improvements and bug fixes"
            output="$jp_output"
          fi

          # è¤‡æ•°è¡Œå‡ºåŠ›ã‚’EOFã§è¨­å®š
          echo "summary<<EOF" >> "$GITHUB_OUTPUT"
          echo -e "$output" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Get Known Issues
        id: issues
        shell: bash
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          # GraphQLã‚¯ã‚¨ãƒªã‚’1è¡Œã§ä½œæˆ
          repo_owner=$(echo "${GITHUB_REPOSITORY}" | cut -d'/' -f1)
          repo_name=$(echo "${GITHUB_REPOSITORY}" | cut -d'/' -f2)
          query="query { repository(owner: \\\"$repo_owner\\\", name: \\\"$repo_name\\\") { issues(first: 5, states: OPEN, labels: [\\\"bug\\\"]) { nodes { title url } } } }"

          # GitHub APIã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
          response=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" -H "Content-Type: application/json" \
            -d "{\"query\": \"$query\"}" https://api.github.com/graphql)

          # è¤‡æ•°è¡Œå‡ºåŠ›ã‚’EOFã§è¨­å®š
          echo "issues<<EOF" >> "$GITHUB_OUTPUT"
          echo -e "$issues" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          draft: false
          prerelease: false
          files: |
            Illustra-${{ github.ref_name }}.zip
          body: |
            ## ğŸš€ Illustra ${{ github.ref_name }}

            ### æ—¥æœ¬èª

            #### ğŸ“¦ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•
            1. Illustra-${{ github.ref_name }}.zip ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            2. ãŠå¥½ã¿ã®å ´æ‰€ã«å±•é–‹
            3. Illustra.exe ã‚’å®Ÿè¡Œ

            #### ğŸ’» å‹•ä½œç’°å¢ƒ
            - Windows 10/11
            - .NET 9.0 ä»¥é™ï¼ˆå®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«ã«åŒæ¢±ï¼‰

            #### ğŸ“ å¤‰æ›´ç‚¹
            ${{ steps.read_release_notes.outputs.summary }}

            #### ğŸ” æ—¢çŸ¥ã®å•é¡Œ
            - Issues ã‚¿ãƒ–ã‚’ç¢ºèªã—ã¦ãã ã•ã„

            ---

            ### English

            #### ğŸ“¦ Installation
            1. Download Illustra-${{ github.ref_name }}.zip
            2. Extract to your preferred location
            3. Run Illustra.exe

            #### ğŸ’» System Requirements
            - Windows 10/11
            - .NET 9.0 or later (included in executable)

            #### ğŸ“ Changes
            ${{ steps.read_release_notes.outputs.summary }}

            #### ğŸ” Known Issues
            - Check the Issues tab
