name: Release

on:
  push:
    tags:
      - "v*.*.*"

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write
      issues: read # æ—¢çŸ¥ã®å•é¡Œã‚’å–å¾—ã™ã‚‹ãŸã‚ã®æ¨©é™

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # ã™ã¹ã¦ã®å±¥æ­´ã‚’å–å¾—ã—ã¦å¤‰æ›´å±¥æ­´ã‚’ç”Ÿæˆã™ã‚‹ãŸã‚

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Restore dependencies
        run: dotnet restore src/Illustra.csproj

      - name: Display GitVersion Info
        run: |
          dotnet tool install --global GitVersion.Tool
          dotnet gitversion /config src/GitVersion.yml /output buildserver
          dotnet gitversion /config src/GitVersion.yml /output json
          echo "Assembly Version: $env:GitVersion_AssemblySemVer"
          echo "File Version: $env:GitVersion_AssemblySemFileVer"
          echo "Informational Version: $env:GitVersion_InformationalVersion"

      - name: Build
        run: dotnet build src/Illustra.csproj --no-restore --configuration Release

      - name: Publish
        run: dotnet publish src/Illustra.csproj -c Release -o publish --self-contained true -r win-x64 /p:PublishSingleFile=true /p:IncludeNativeLibrariesForSelfExtract=true

      - name: Create ZIP archive
        shell: bash # Windowsã§ã‚‚Bashã§çµ±ä¸€
        run: |
          cd publish
          7z a -tzip "../Illustra-${GITHUB_REF_NAME}.zip" *

      - name: Read Release Notes
        id: read_release_notes
        shell: bash
        run: |
          if [ -f ".github/workflows/summary.txt" ]; then
            notes=$(cat .github/workflows/summary.txt | tr -d '\r') # Windowsã®æ”¹è¡Œã‚³ãƒ¼ãƒ‰å¯¾ç­–
            if [ -z "$notes" ]; then
              notes="- ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã®æ”¹å–„ã¨ãƒã‚°ä¿®æ­£"
            fi
          else
            notes="- ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã®æ”¹å–„ã¨ãƒã‚°ä¿®æ­£\n- ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Š"
          fi
          # è¤‡æ•°è¡Œå‡ºåŠ›ã‚’EOFã§è¨­å®š
          echo "summary<<EOF" >> "$GITHUB_OUTPUT"
          echo -e "$notes" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Get Known Issues
        id: issues
        shell: bash
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          # GraphQLã‚¯ã‚¨ãƒªã‚’1è¡Œã§ä½œæˆ
          repo_owner=$(echo "${GITHUB_REPOSITORY}" | cut -d'/' -f1)
          repo_name=$(echo "${GITHUB_REPOSITORY}" | cut -d'/' -f2)
          query="query { repository(owner: \\\"$repo_owner\\\", name: \\\"$repo_name\\\") { issues(first: 5, states: OPEN, labels: [\\\"bug\\\"]) { nodes { title url } } } }"

          # GitHub APIã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
          response=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" -H "Content-Type: application/json" \
            -d "{\"query\": \"$query\"}" https://api.github.com/graphql)

          # æ—¢çŸ¥ã®å•é¡Œãƒªã‚¹ãƒˆã‚’ç”Ÿæˆ
          issues=$(echo "$response" | jq -r '.data.repository.issues.nodes[] | "- [\(.title)](\(.url))"')

          # æ—¢çŸ¥ã®å•é¡ŒãŒãªã„å ´åˆã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
          if [ -z "$issues" ]; then
            issues="- ç¾åœ¨ã€æ—¢çŸ¥ã®å•é¡Œã¯ã‚ã‚Šã¾ã›ã‚“ã€‚"
          fi

          # è¤‡æ•°è¡Œå‡ºåŠ›ã‚’EOFã§è¨­å®š
          echo "issues<<EOF" >> "$GITHUB_OUTPUT"
          echo -e "$issues" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          draft: false
          prerelease: false
          files: |
            Illustra-${{ github.ref_name }}.zip
          body: |
            ## ğŸš€ Illustra ${{ github.ref_name }}

            ### ğŸ“¦ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•
            1. Illustra-${{ github.ref_name }}.zip ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            2. ãŠå¥½ã¿ã®å ´æ‰€ã«å±•é–‹
            3. Illustra.exe ã‚’å®Ÿè¡Œ

            ### ğŸ’» å‹•ä½œç’°å¢ƒ
            - Windows 10/11
            - .NET 9.0 ä»¥é™ï¼ˆå®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«ã«åŒæ¢±ï¼‰

            ### ğŸ“ å¤‰æ›´ç‚¹
            ${{ steps.read_release_notes.outputs.summary }}

            ### ğŸ” æ—¢çŸ¥ã®å•é¡Œ
            ${{ steps.issues.outputs.issues }}
